<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>kanikamaテスト</title>
</head>
<body>
kanikamaテスト
<br/><br/>
旧kanikama(http://lab.calil.jp/kanikama/sabae/kanikama.js)と鯖江アプリ用kanikamaで結果が同じになるかのテスト<br/>
floorのエラーを検証<br/>
<br/>
--<br/>

<div id="result" style="white-space: pre-wrap;"></div>

<!-- 依存 -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="../vendor/geolib.js"></script>
<script src="../buffer.js"></script>

<script src="http://lab.calil.jp/kanikama/sabae/kanikama.js"></script>
<script>
    var OldKanikama = Kanikama;
</script>

<!-- テスト対象 -->
<script src="../kanikama.js"></script>

<!-- テスト -->
<script>
    var kanikama = new OldKanikama();
    var newKanikama = new Kanikama();

    $(function () {
        $.when(
                $.getJSON('https://app.haika.io/api/facility/7/7.geojson'),
                $.getJSON('https://app.haika.io/api/facility/7/8.geojson')
        ).then(
                function () {
                    var data, j, len;
                    for (j = 0, len = arguments.length; j < len; j++) {
                        data = arguments[j];
                        if (data[1] === 'success') {
                            kanikama.addGeoJSON(data[0]);
                            newKanikama.addGeoJSON(data[0]);
                        }
                    }
                }).then(function () {
                    showResult('テスト開始');
                    testFloorChange();
                }
        );
    });

    /**
     * フロアのバグ検証
     */
    test = function() {
        showResult('\n--');
        showResult('ビーコンあり');
        try {
            kanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            kanikama.facilityDetector();
            kanikama.floorDetector();
            showResult('旧:' + kanikama.floor.label_jp);
        } catch (e) {
            showResult('旧:' + e.toString());
        }
        try {
            newKanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            newKanikama.facilityDetector();
            newKanikama.floorDetector();
            showResult('新:' + kanikama.floor.label_jp);
        } catch (e) {
            showResult('新:' + e.toString());
            throw e;
        }
        showResult('OK');

        showResult('\n--');
        showResult('ビーコン あり→なし 仕様: ビーコンが無くなってもフロアを継続すること');
        try {
            kanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            kanikama.facilityDetector();
            kanikama.floorDetector();

            kanikama.buffer.push([]);
            kanikama.floorDetector();
            showResult('旧:' + kanikama.floor.label_jp);

        } catch (e) {
            showResult('旧:' + e.toString());
        }
        try {
            newKanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            newKanikama.facilityDetector();
            newKanikama.floorDetector();

            newKanikama.buffer.push([]);
            newKanikama.floorDetector();
            showResult('新:' + kanikama.floor.label_jp);
        } catch (e) {
            showResult('新:' + e.toString());
            throw e;
        }
        showResult('OK');
    };

    testFloorChange = function() {
        showResult('\n--');
        showResult('floorChangeイベントが複数回発生しない');
        var changeCount = 0;
        try {
            var label;
            kanikama.onChangeFloor = function () {
                changeCount++;
                showResult('onChangeFloor');
            };
            kanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            kanikama.facilityDetector();
            kanikama.floorDetector();
            label = kanikama.floor != null ? kanikama.floor.label_jp : null;
            showResult('旧: ビーコンあり ' + label);

            kanikama.waitElapsed += 10000; // 時間を進めておく

            kanikama.buffer.push([]);
            kanikama.floorDetector();
            label = kanikama.floor != null ? kanikama.floor.label_jp : null;
            showResult('旧: ビーコンなし ' + label);

            kanikama.waitElapsed += 10000; // 時間を進めておく

            kanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            kanikama.floorDetector();
            label = kanikama.floor != null ? kanikama.floor.label_jp : null;
            showResult('旧: ビーコンあり ' + label);

            if (changeCount != 1) {
                throw new Error('イベント回数異常' + changeCount);
            }

            showResult('旧:' + kanikama.floor.label_jp);
        } catch (e) {
            showResult('旧:' + e.toString());
        }
        var newChangeCount = 0;
        try {
            newKanikama.onChangeFloor = function () {
                newChangeCount++;
                showResult('onChangeFloor');
            };
            newKanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            newKanikama.facilityDetector();
            newKanikama.floorDetector();
            showResult('新: ビーコンあり ' + kanikama.floor.label_jp);

            newKanikama.waitElapsed += 10000; // 時間を進めておく

            newKanikama.buffer.push([]);
            newKanikama.floorDetector();
            showResult('新: ビーコンなし ' + kanikama.floor.label_jp);

            newKanikama.waitElapsed += 10000; // 時間を進めておく

            newKanikama.buffer.push([{uuid: '00000000-71C7-1001-B000-001C4D532518', major: 105, minor: 132, rssi: -60}]);
            newKanikama.floorDetector();
            showResult('新: ビーコンあり ' + kanikama.floor.label_jp);

            if (newChangeCount != 1) {
                throw new Error('イベント回数異常' + newChangeCount);
            }

            showResult('新:' + kanikama.floor.label_jp);
        } catch (e) {
            showResult('新:' + e.toString());
            throw e;
        }
        showResult('OK');
    };

    showResult = function (text) {
        return setTimeout(function () {
            return $('#result').text($('#result').text() + text + '\n');
        }, 10);
    };
</script>
</body>
</html>
